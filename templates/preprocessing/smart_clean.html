{% extends "base.html" %}
{% load static %}

{% block title %}Smart Clean - {{ event_log.name }}{% endblock %}

{% block content %}
<div class="pm-container">
  <!-- Disco-like Step Bar -->
  <div class="pm-step-bar">
    <a href="{% url 'preprocessing_dashboard' %}" class="pm-step pm-step-link">
      <div class="pm-step-number">1</div>
      <div class="pm-step-label">Upload</div>
    </a>
    <div class="pm-step pm-step-active">
      <div class="pm-step-number">2</div>
      <div class="pm-step-label">Smart Clean</div>
    </div>
    <a href="{% url 'discover_view' event_log.id %}" class="pm-step pm-step-link">
      <div class="pm-step-number">3</div>
      <div class="pm-step-label">Discovery</div>
    </a>
    <a href="{% url 'discover_view' event_log.id %}" class="pm-step pm-step-link">
      <div class="pm-step-number">4</div>
      <div class="pm-step-label">Visualization</div>
    </a>
    <a href="{% url 'conformance_view' event_log.id %}" class="pm-step pm-step-link">
      <div class="pm-step-number">5</div>
      <div class="pm-step-label">Conformance</div>
    </a>
    <a href="/prediction/" class="pm-step pm-step-link">
      <div class="pm-step-number">6</div>
      <div class="pm-step-label">Prediction</div>
    </a>
  </div>

  <!-- Main Content Area -->
  <div class="pm-main-content">
    <!-- Log Info Card -->
    <div class="pm-card pm-log-info-card">
      <h2>{{ event_log.name }}</h2>
      <div class="pm-stats-grid">
        <div class="pm-stat">
          <label>File Type:</label>
          <span>{{ event_log.file_type|upper }}</span>
        </div>
        <div class="pm-stat">
          <label>Cases:</label>
          <span id="stat-cases">
            {% if event_log.default_source_for_downstream == 'cleaned' and cleaned_stats %}
              {{ cleaned_stats.num_cases|default:"—" }}
            {% elif raw_stats %}
              {{ raw_stats.num_cases|default:"—" }}
            {% else %}
              {{ event_log.num_cases|default:"—" }}
            {% endif %}
          </span>
        </div>
        <div class="pm-stat">
          <label>Events:</label>
          <span id="stat-events">
            {% if event_log.default_source_for_downstream == 'cleaned' and cleaned_stats %}
              {{ cleaned_stats.num_events|default:"—" }}
            {% elif raw_stats %}
              {{ raw_stats.num_events|default:"—" }}
            {% else %}
              {{ event_log.num_events|default:"—" }}
            {% endif %}
          </span>
        </div>
        <div class="pm-stat">
          <label>Activities:</label>
          <span id="stat-activities">
            {% if event_log.default_source_for_downstream == 'cleaned' and cleaned_stats %}
              {{ cleaned_stats.num_activities|default:"—" }}
            {% elif raw_stats %}
              {{ raw_stats.num_activities|default:"—" }}
            {% else %}
              {{ event_log.num_activities|default:"—" }}
            {% endif %}
          </span>
        </div>
      </div>

      <!-- Default Source Selector -->
      <div class="pm-source-selector">
        <label>Default source for downstream modules:</label>
        <div class="pm-radio-group">
          <label class="pm-radio">
            <input type="radio" name="default_source" value="raw" 
                   {% if event_log.default_source_for_downstream == 'raw' %}checked{% endif %}>
            <span>Use RAW log</span>
          </label>
          <label class="pm-radio">
            <input type="radio" name="default_source" value="cleaned"
                   {% if event_log.default_source_for_downstream == 'cleaned' %}checked{% endif %}
                   {% if not event_log.has_cleaned_version %}disabled{% endif %}>
            <span>Use CLEANED log</span>
          </label>
        </div>
        <span class="pm-badge pm-badge-source" id="source-badge">
          Current: {{ event_log.default_source_for_downstream|upper }}
        </span>
      </div>

      <!-- Action Buttons -->
      <div class="pm-actions">
        <button class="pm-btn pm-btn-secondary" onclick="previewTable('raw')">
          Preview RAW log
        </button>
        <button class="pm-btn pm-btn-primary" id="btn-smart-clean" onclick="triggerSmartClean()">
          Smart Clean
        </button>
        <button class="pm-btn pm-btn-success" id="btn-preview-cleaned" 
                onclick="previewTable('cleaned')"
                {% if not event_log.has_cleaned_version %}disabled{% endif %}>
          Preview CLEANED log
        </button>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="status-message" class="pm-status-message" style="display: none;"></div>

    <!-- Cleaning Stats (shown after cleaning) -->
    <div id="cleaning-stats" class="pm-card pm-cleaning-stats" style="display: none;">
      <h3 style="color: #212529;">Cleaning Results</h3>
      <div class="pm-stats-comparison">
        <div class="pm-stats-col">
          <h4>Before (RAW)</h4>
          <div id="raw-stats"></div>
        </div>
        <div class="pm-stats-col">
          <h4>After (CLEANED)</h4>
          <div id="cleaned-stats"></div>
        </div>
      </div>
    </div>

    <!-- Data Table Tabs -->
    <div class="pm-card pm-table-card">
      <div class="pm-tabs">
        <button class="pm-tab pm-tab-active" data-tab="raw" onclick="switchTab('raw')">
          RAW Table
        </button>
        <button class="pm-tab" data-tab="cleaned" id="tab-cleaned" onclick="switchTab('cleaned')"
                {% if not event_log.has_cleaned_version %}disabled{% endif %}>
          CLEANED Table
        </button>
      </div>

      <div class="pm-tab-content">
        <!-- RAW Table -->
        <div id="table-raw" class="pm-table-wrapper">
          <div class="pm-table-controls">
            <span id="table-info-raw" class="pm-table-info"></span>
            <div class="pm-pagination" id="pagination-raw"></div>
          </div>
          <div class="pm-table-scroll">
            <table class="pm-table" id="data-table-raw">
              <thead id="thead-raw"></thead>
              <tbody id="tbody-raw">
                <tr><td colspan="100">Click "Preview RAW log" to load data</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- CLEANED Table -->
        <div id="table-cleaned" class="pm-table-wrapper" style="display: none;">
          <div class="pm-table-controls">
            <span id="table-info-cleaned" class="pm-table-info"></span>
            <div class="pm-pagination" id="pagination-cleaned"></div>
          </div>
          <div class="pm-table-scroll">
            <table class="pm-table" id="data-table-cleaned">
              <thead id="thead-cleaned"></thead>
              <tbody id="tbody-cleaned">
                <tr><td colspan="100">Run Smart Clean first</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="pm-footer-actions">
    <a href="{% url 'preprocessing_dashboard' %}" class="pm-btn pm-btn-outline">
      ← Back to Dashboard
    </a>
    <a href="{% url 'discover_view' event_log.id %}" class="pm-btn pm-btn-primary">
      Next: Discovery →
    </a>
  </div>
</div>

<script>
const LOG_ID = {{ event_log.id }};
let currentTab = 'raw';
let currentPage = {'raw': 1, 'cleaned': 1};
const PAGE_SIZE = 50;

// CSRF Token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Show status message
function showStatus(message, type = 'info') {
  const statusEl = document.getElementById('status-message');
  statusEl.textContent = message;
  statusEl.className = `pm-status-message pm-status-${type}`;
  statusEl.style.display = 'block';
  
  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      statusEl.style.display = 'none';
    }, 5000);
  }
}

// Trigger Smart Clean
async function triggerSmartClean() {
  const btn = document.getElementById('btn-smart-clean');
  btn.disabled = true;
  btn.innerHTML = '<span class="pm-spinner"></span> Cleaning...';
  
  showStatus('Running Smart Clean pipeline...', 'info');
  
  try {
    const response = await fetch(`/api/event-logs/${LOG_ID}/smart_clean/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({
        aggressive: false,
        normalize_names: true,
      }),
    });
    
    const result = await response.json();
    
    if (response.ok && result.status === 'success') {
      showStatus('Smart Clean completed successfully!', 'success');
      
      // Display cleaning stats
      displayCleaningStats(result.data);
      
      // Enable cleaned preview button and tab
      document.getElementById('btn-preview-cleaned').disabled = false;
      document.getElementById('tab-cleaned').disabled = false;
      
      // Enable cleaned radio button
      const cleanedRadio = document.querySelector('input[name="default_source"][value="cleaned"]');
      cleanedRadio.disabled = false;
      
      btn.innerHTML = '<span class="pm-btn-icon">✅</span> Clean Complete';
      
      // Auto-switch to cleaned tab
      setTimeout(() => {
        switchTab('cleaned');
        previewTable('cleaned');
      }, 1000);
    } else {
      throw new Error(result.message || 'Failed to clean log');
    }
  } catch (error) {
    showStatus(`Error: ${error.message}`, 'error');
    btn.disabled = false;
    btn.innerHTML = 'Smart Clean';
  }
}

// Display cleaning statistics
function displayCleaningStats(data) {
  const statsDiv = document.getElementById('cleaning-stats');
  const rawStatsDiv = document.getElementById('raw-stats');
  const cleanedStatsDiv = document.getElementById('cleaned-stats');
  
  const formatStats = (stats) => {
    return `
      <p><strong>Events:</strong> ${stats.num_events || 0}</p>
      <p><strong>Cases:</strong> ${stats.num_cases || 0}</p>
      <p><strong>Activities:</strong> ${stats.num_activities || 0}</p>
      <p><strong>Columns:</strong> ${stats.num_columns || 0}</p>
    `;
  };
  
  rawStatsDiv.innerHTML = formatStats(data.raw);
  cleanedStatsDiv.innerHTML = formatStats(data.cleaned);
  statsDiv.style.display = 'block';
  
  // Store stats globally for later use
  window.LOG_STATS = {
    raw: data.raw,
    cleaned: data.cleaned
  };
  
  // Update top stats based on current source selection
  updateTopStats();
}

// Update top statistics based on selected source
function updateTopStats() {
  if (!window.LOG_STATS) return;
  
  const selectedSource = document.querySelector('input[name="default_source"]:checked')?.value || 'raw';
  const stats = window.LOG_STATS[selectedSource];
  
  if (stats) {
    document.getElementById('stat-cases').textContent = stats.num_cases || '—';
    document.getElementById('stat-events').textContent = stats.num_events || '—';
    document.getElementById('stat-activities').textContent = stats.num_activities || '—';
  }
}

// Preview table
async function previewTable(version, page = 1) {
  currentPage[version] = page;
  
  // Switch to the corresponding tab
  switchTab(version);
  
  const tbody = document.getElementById(`tbody-${version}`);
  tbody.innerHTML = '<tr><td colspan="100">Loading...</td></tr>';
  
  try {
    const response = await fetch(
      `/api/event-logs/${LOG_ID}/table/?version=${version}&page=${page}&page_size=${PAGE_SIZE}`
    );
    
    const result = await response.json();
    
    if (response.ok && result.status === 'success') {
      renderTable(version, result.data);
    } else {
      throw new Error(result.message || 'Failed to load table');
    }
  } catch (error) {
    tbody.innerHTML = `<tr><td colspan="100" style="color: red;">Error: ${error.message}</td></tr>`;
  }
}

// Render table
function renderTable(version, data) {
  const thead = document.getElementById(`thead-${version}`);
  const tbody = document.getElementById(`tbody-${version}`);
  const tableInfo = document.getElementById(`table-info-${version}`);
  const pagination = document.getElementById(`pagination-${version}`);
  
  // Render header
  thead.innerHTML = '<tr>' + data.columns.map(col => `<th>${col}</th>`).join('') + '</tr>';
  
  // Render body
  tbody.innerHTML = data.data.map(row => 
    '<tr>' + row.map(cell => `<td>${cell !== null ? cell : ''}</td>`).join('') + '</tr>'
  ).join('');
  
  // Table info
  const start = (data.page - 1) * data.page_size + 1;
  const end = Math.min(data.page * data.page_size, data.total_rows);
  tableInfo.textContent = `Showing ${start}-${end} of ${data.total_rows} rows`;
  
  // Pagination
  renderPagination(version, data.page, data.total_pages);
}

// Render pagination
function renderPagination(version, currentPage, totalPages) {
  const pagination = document.getElementById(`pagination-${version}`);
  
  let html = '';
  
  if (currentPage > 1) {
    html += `<button class="pm-btn pm-btn-sm" onclick="previewTable('${version}', ${currentPage - 1})">← Prev</button>`;
  }
  
  html += `<span class="pm-page-info">Page ${currentPage} of ${totalPages}</span>`;
  
  if (currentPage < totalPages) {
    html += `<button class="pm-btn pm-btn-sm" onclick="previewTable('${version}', ${currentPage + 1})">Next →</button>`;
  }
  
  pagination.innerHTML = html;
}

// Switch tabs
function switchTab(tab) {
  // Update tab buttons
  document.querySelectorAll('.pm-tab').forEach(btn => {
    btn.classList.remove('pm-tab-active');
  });
  document.querySelector(`.pm-tab[data-tab="${tab}"]`).classList.add('pm-tab-active');
  
  // Update content
  document.getElementById('table-raw').style.display = tab === 'raw' ? 'block' : 'none';
  document.getElementById('table-cleaned').style.display = tab === 'cleaned' ? 'block' : 'none';
  
  currentTab = tab;
}

// Update default source
document.querySelectorAll('input[name="default_source"]').forEach(radio => {
  radio.addEventListener('change', async function() {
    const source = this.value;
    
    // Update top stats immediately when switching
    updateTopStats();
    
    try {
      const response = await fetch(`/api/event-logs/${LOG_ID}/default_source/`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify({
          default_source_for_downstream: source,
        }),
      });
      
      const result = await response.json();
      
      if (response.ok && result.status === 'success') {
        showStatus(`Default source updated to ${source.toUpperCase()}`, 'success');
        document.getElementById('source-badge').textContent = `Current: ${source.toUpperCase()}`;
      } else {
        throw new Error(result.message || 'Failed to update');
      }
    } catch (error) {
      showStatus(`Error: ${error.message}`, 'error');
      // Revert radio
      document.querySelector(`input[name="default_source"][value="${source === 'raw' ? 'cleaned' : 'raw'}"]`).checked = true;
    }
  });
});

// Auto-load RAW table and statistics on page load
window.addEventListener('DOMContentLoaded', async () => {
  previewTable('raw', 1);
  
  // Initialize stats from server-side data
  window.LOG_STATS = {
    raw: {{ raw_stats_json|safe }},
    cleaned: {{ cleaned_stats_json|safe }}
  };
  
  // Update top stats based on current selection
  updateTopStats();
});
</script>

<style>
/* Process Mining Disco-like Styles */
.pm-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.pm-step-bar {
  display: flex;
  justify-content: space-between;
  margin-bottom: 30px;
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
}

.pm-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
  position: relative;
  text-decoration: none;
  color: inherit;
}

.pm-step-link {
  cursor: pointer;
  transition: all 0.2s;
}

.pm-step-link:hover .pm-step-number {
  background: #0056b3;
  color: white;
  transform: scale(1.1);
}

.pm-step-link:hover .pm-step-label {
  color: #0056b3;
}

.pm-step:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 20px;
  left: 60%;
  width: 80%;
  height: 2px;
  background: #dee2e6;
}

.pm-step-active::after {
  background: #007bff;
}

.pm-step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #dee2e6;
  color: #6c757d;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  margin-bottom: 8px;
  z-index: 1;
}

.pm-step-active .pm-step-number {
  background: #007bff;
  color: white;
}

.pm-step-label {
  font-size: 14px;
  color: #495057;
  font-weight: 500;
}

.pm-step-active .pm-step-label {
  color: #007bff;
  font-weight: 600;
}

.pm-step-disabled .pm-step-label {
  color: #868e96;
}

.pm-card {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.pm-log-info-card h2 {
  margin: 0 0 20px 0;
  color: #212529;
}

.pm-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.pm-stat {
  display: flex;
  flex-direction: column;
}

.pm-stat label {
  font-size: 13px;
  color: #495057;
  margin-bottom: 4px;
  font-weight: 500;
}

.pm-stat span {
  font-size: 20px;
  font-weight: 600;
  color: #212529;
}

.pm-source-selector {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 6px;
  margin-bottom: 20px;
}

.pm-source-selector > label {
  font-size: 14px;
  color: #212529;
  font-weight: 600;
  display: block;
  margin-bottom: 8px;
}

.pm-radio-group {
  display: flex;
  gap: 20px;
  margin: 12px 0;
}

.pm-radio {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  color: #212529;
  font-size: 14px;
}

.pm-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.pm-badge-source {
  background: #e7f3ff;
  color: #0066cc;
}

.pm-actions {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.pm-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.pm-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pm-btn-primary {
  background: #007bff;
  color: white;
}

.pm-btn-primary:hover:not(:disabled) {
  background: #0056b3;
}

.pm-btn-secondary {
  background: #6c757d;
  color: white;
}

.pm-btn-success {
  background: #28a745;
  color: white;
}

.pm-btn-outline {
  background: white;
  border: 1px solid #dee2e6;
  color: #495057;
}

.pm-btn-sm {
  padding: 6px 12px;
  font-size: 13px;
}

.pm-status-message {
  padding: 12px 16px;
  border-radius: 6px;
  margin-bottom: 20px;
  font-size: 14px;
}

.pm-status-info {
  background: #e7f3ff;
  color: #004085;
  border-left: 4px solid #007bff;
}

.pm-status-success {
  background: #d4edda;
  color: #155724;
  border-left: 4px solid #28a745;
}

.pm-status-error {
  background: #f8d7da;
  color: #721c24;
  border-left: 4px solid #dc3545;
}

.pm-cleaning-stats {
  background: #f0f8ff;
}

.pm-stats-comparison {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.pm-stats-col h4 {
  margin: 0 0 12px 0;
  color: #212529;
  font-size: 16px;
}

.pm-stats-col p {
  margin: 4px 0;
  color: #212529;
  font-size: 14px;
}

.pm-stats-col strong {
  color: #212529;
  font-weight: 600;
}

.pm-tabs {
  display: flex;
  gap: 4px;
  border-bottom: 2px solid #dee2e6;
  margin-bottom: 20px;
}

.pm-tab {
  padding: 10px 20px;
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #495057;
  transition: all 0.2s;
}

.pm-tab:hover:not(:disabled) {
  color: #007bff;
  background: #f8f9fa;
}

.pm-tab-active {
  color: #007bff;
  border-bottom-color: #007bff;
  font-weight: 600;
}

.pm-tab:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pm-table-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.pm-table-info {
  font-size: 14px;
  color: #212529;
  font-weight: 500;
}

.pm-pagination {
  display: flex;
  gap: 8px;
  align-items: center;
}

.pm-page-info {
  font-size: 14px;
  color: #212529;
  margin: 0 8px;
  font-weight: 500;
}

.pm-table-scroll {
  overflow-x: auto;
  max-height: 600px;
  overflow-y: auto;
}

.pm-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.pm-table th {
  background: #f8f9fa;
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  color: #212529;
  border-bottom: 2px solid #dee2e6;
  position: sticky;
  top: 0;
  z-index: 1;
}

.pm-table td {
  padding: 8px 12px;
  border-bottom: 1px solid #f1f3f5;
  color: #212529;
}

.pm-table tbody tr:hover {
  background: #f8f9fa;
}

.pm-spinner {
  display: inline-block;
  width: 14px;
  height: 14px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.pm-footer-actions {
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #dee2e6;
}
</style>
{% endblock %}
